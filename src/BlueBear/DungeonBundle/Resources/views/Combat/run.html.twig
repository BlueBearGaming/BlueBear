{% extends '@BlueBearBackoffice/layout.html.twig' %}

{% block container %}
    {% if response %}
        <h2>Combat will begin !!!</h2>

        <form action="{{ path('bluebear.dungeon.combat.run', {gameId: app.request.get('gameId')}) }}"
              method="post" class="combat-form">
            <input type="hidden" name="eventData" value="{{ eventData | json_encode }}"/>
            <input type="submit" class="btn btn-default start-button" value="Start"/>
        </form>

        <div class="combat-container">

        </div>

        {#<div class="hide">#}
            {#<div class="turn-template">#}
                {#Name : __NAME__<br/>#}
                {#HitPoints : __HIT_POINTS__<br/>#}
                {#Attacks : __ATTACKS__#}

            {#</div>#}

            {#<div class="attack-template">#}
                {#<form action="{{ path('bluebear_engine_trigger_event', {eventName: 'bluebear.combat.attack'}) }}"#}
                      {#method="post" class="attack-form">#}
                    {#__NAME__<br/>#}
                    {#__DESCRIPTION__<br/>#}
                    {#<input type="hidden" name="eventData" value=""/>#}
                    {#<input type="submit" value="Attack" class="btn btn-success"/>#}
                {#</form>#}
            {#</div>#}
        {#</div>#}

    {% else %}
        Error on combat creation... Loser !
    {% endif %}
    <script>
        $(document).on('ready', function () {
            var combatForm = $('.combat-form');
            var combatContainer = $('.combat-container');
            var turnTemplate = $('.turn-template');
            var attackTemplate = $('.attack-template');

            combatForm.on('submit', function () {

                $.ajax({
                    url: combatForm.attr('action'),
                    method: 'post',
                    data: combatForm.serialize(),
                    success: function (response) {
                        //console.log(response);

                        if (response.name == 'bluebear.combat.init') {
                            combatForm.attr('action', response.endPoint);
                        } else if (response.name == 'bluebear.game.turn') {
                            var existing = combatContainer.find('.turn-' + response.data.turn);
                            //console.log('response', existing);

                            if (existing.length) {
                                existing.replaceWith($(response.data.content));
                            } else {
                                combatContainer.append($(response.data.content));
                            }
//                            combatContainer.find('.attack-form').off().on('submit', function () {
//                                console.log('submit ?');
//                                return false;
//                            });

//                            var turnClass = 'turn' + response.data.turn + '-' + response.data.entityInstance.id;
//                            var existing = combatContainer.find('.' + turnClass);
//                            var newTurn = turnTemplate.clone();
//                            var attacksContent = [];
//                            $.each(response.data.attacks, function (index, value) {
//                                var newAttack = attackTemplate.clone();
//                                newAttack.html(newAttack.html().replace('__NAME__', value.label));
//                                newAttack.html(newAttack.html().replace('__DESCRIPTION__', value.description));
//                                attacksContent.push(newAttack.html());
//                            });
//                            newTurn.html(newTurn.html().replace('__NAME__', response.data.entityInstance.label));
//                            newTurn.html(newTurn.html().replace('__HIT_POINTS__', response.data.entityInstance.hitPoints));
//                            newTurn.html(newTurn.html().replace('__ATTACKS__', attacksContent));
//
//                            newTurn.addClass(turnClass);
//
//                            if (existing.length) {
//                                existing.replaceWith(newTurn);
//                            } else {
//                                combatContainer.append(newTurn);
//                            }

                        }
                    }
                });

                return false;
            });
        });
    </script>
{% endblock %}

