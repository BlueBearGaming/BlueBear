{% extends '@BlueBearBackoffice/layout.html.twig' %}

{% block container %}
    {% if response %}

        {{ dump(response) }}


        Combat will begin !!!
        <br/>
        <form action="{{ path('bluebear.dungeon.combat.run', {gameId: app.request.get('gameId')}) }}" method="post"
              class="combat-form">


            <input type="hidden" name="eventData" value="{{ response.data | json_encode }}"/>

            <input type="submit" class="btn btn-default" value="Start"/>
        </form>

        <div class="combat-container">

        </div>

        <div class="hide">
            <div class="turn-template">
                Name : __NAME__<br/>
                HitPoints : __HIT_POINTS__<br/>
                Attacks : __ATTACK__
            </div>
        </div>







    {% else %}
        Error on combat creation... Loser !
    {% endif %}
    <script>
        $(document).on('ready', function () {
            var combatForm = $('.combat-form');
            var combatContainer = $('.combat-container');
            var turnTemplate = $('.turn-template');

            combatForm.on('submit', function () {

                $.ajax({
                    url: combatForm.attr('action'),
                    method: 'post',
                    data: combatForm.serialize(),
                    success: function (response) {
                        console.log(response);

                        if (response.name == 'bluebear.combat.init') {
                            combatForm.attr('action', response.endPoint);
                        } else if (response.name == 'bluebear.game.turn') {
                            var newTurn = turnTemplate.clone();
                            newTurn.html(newTurn.html().replace('__NAME__', response.data.entityInstance.label));
                            combatContainer.append(newTurn);
                        }
                    }
                });

                return false;
            });
        });
    </script>
{% endblock %}

